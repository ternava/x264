# x264 and gcov

The goal is to use `gcov` (and actually other utilities) to understand the effects of x264 command line options (eg `--no-mbtree`) and x264 inputs (videos) on code (eg coverage). 
For instance, what is the effect of activating an option? What are the functions newly covered/called? 
Beyond the task of understanding x264, we could well use this covering information to debloat parts of the code. 

This branch is an exact copy of the x264 master branch (original source code) and some scripts (bash, Python).

## Implementation 

A pre-requisite of `gcov` is that specific gcc flags should be used to compile the code. 
After a basic `./configure`, it is possible to edit `config.mak` 

I've added: `CFLAGS=-fprofile-arcs -ftest-coverage` 
and `LDFLAGS=-m64  -lm -lpthread -ldl -lgcov -fprofile-arcs` 

Then `make` to compile the source code with the flags. 

Traditional tutorials on `gcov` do not consider the case where you can change the command line parameters of the program. 
It is strange, maybe I miss something. 

As a workaround (very ad-hoc solution, sorry), I've decided to "inject" the arguments of x264 directly in the main. 

something like:
```
 argc = 5;
argv[0] = "x264"; 
argv[1] = "--no-cabac"; 
argv[2] = "benchs/inputs/original_videos_LyricVideo_360P_LyricVideo_360P-5e87.mkv"; 
argv[3] = "-o"; 
argv[4] = "o1.mkv"; 
``` 

It relies on the file `x264.c.old` which is an exact copy of the original `x264.c` with a magic keyword/comment that can be substituted by a value. 
This value is generated by a Python script `x264_replace_args.py` that generates the `argv` stuff. 

There is finally a whole Bash script that calls everything `x264-coverage.sh`.
It is supposed to generate a report on code coverage (in the directory `x264-coverage_report`). 

This script can be changed (command line options or input videos). 
The idea is to call this script with different options/videos and then compare the different coverages. 

Note: I assume the existence of videos here: 
```
ls benchs/inputs/
original_videos_Animation_480P_Animation_480P-087e.mkv  original_videos_Gaming_360P_Gaming_360P-56fe.mkv    original_videos_LiveMusic_360P_LiveMusic_360P-1d94.mkv    original_videos_MusicVideo_360P_MusicVideo_360P-5699.mkv  README.md
original_videos_CoverSong_360P_CoverSong_360P-5d20.mkv  original_videos_Lecture_360P_Lecture_360P-114f.mkv  original_videos_LyricVideo_360P_LyricVideo_360P-5e87.mkv  original_videos_Sports_360P_Sports_360P-4545.mkv
```



## Resources

https://stackoverflow.com/questions/55765083/running-gcov-on-a-program-with-arguments
https://alex.dzyoba.com/blog/gprof-gcov/




